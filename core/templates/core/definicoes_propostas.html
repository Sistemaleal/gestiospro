{% extends "core/base.html" %}
{% load static %}

{% block title %}Definições de propostas{% endblock %}

{% block header %}
<div class="page-header">
  <div class="page-header__title">
    <h1>Definições de propostas</h1>
    <p class="text-muted">
      Textos padrão de propostas e configurações gerais. Esses textos serão usados automaticamente nas propostas geradas pelo sistema.
    </p>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="card card-page card-config">

  <form method="post" class="config-form" enctype="multipart/form-data">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-error">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <!-- ========================= -->
    <!-- TEXTOS PADRÃO             -->
    <!-- ========================= -->
    <section class="cfg-section">
      <header class="cfg-section__header">
        <h2 class="cfg-section__title">Textos padrão</h2>
        <p class="cfg-section__help">
          Esses textos serão usados automaticamente nas propostas geradas pelo sistema.
        </p>
      </header>

      <div class="cfg-grid">
        <div class="cfg-field cfg-field--full">
          <label class="cfg-label" for="{{ form.exclusoes.id_for_label }}">Exclusões</label>
          <div class="cfg-control">
            {{ form.exclusoes }}
          </div>
          <div class="cfg-errors">{{ form.exclusoes.errors }}</div>
          <p class="cfg-hint text-muted">Liste itens que não estão inclusos no escopo.</p>
        </div>

        <div class="cfg-subtitle cfg-field--full">
          <h3>Prazos</h3>
          <p class="text-muted">Prazo padrão exibido nas propostas para início e entrega dos serviços.</p>
        </div>

        <div class="cfg-field">
          <label class="cfg-label" for="{{ form.prazo_inicio.id_for_label }}">Prazo para início dos serviços</label>
          <div class="cfg-control">
            {{ form.prazo_inicio }}
          </div>
          <div class="cfg-errors">{{ form.prazo_inicio.errors }}</div>
        </div>

        <div class="cfg-field">
          <label class="cfg-label" for="{{ form.prazo_entrega.id_for_label }}">Prazo para entrega dos serviços</label>
          <div class="cfg-control">
            {{ form.prazo_entrega }}
          </div>
          <div class="cfg-errors">{{ form.prazo_entrega.errors }}</div>
        </div>

        <div class="cfg-field cfg-field--full">
          <label class="cfg-label" for="{{ form.declaracoes.id_for_label }}">Declarações</label>
          <div class="cfg-control">
            {{ form.declaracoes }}
          </div>
          <div class="cfg-errors">{{ form.declaracoes.errors }}</div>
        </div>

        <div class="cfg-field cfg-field--full">
          <label class="cfg-label" for="{{ form.termo_confi.id_for_label }}">Termo de confidencialidade</label>
          <div class="cfg-control">
            {{ form.termo_confi }}
          </div>
          <div class="cfg-errors">{{ form.termo_confi.errors }}</div>
        </div>

        <div class="cfg-field cfg-field--full">
          <label class="cfg-label" for="{{ form.agradecimentos.id_for_label }}">Agradecimentos / assinatura</label>
          <div class="cfg-control">
            {{ form.agradecimentos }}
          </div>
          <div class="cfg-errors">{{ form.agradecimentos.errors }}</div>
        </div>
      </div>
    </section>

  
    <!-- ========================= -->
    <!-- NUMERAÇÃO AUTOMÁTICA      -->
    <!-- ========================= -->
    <section class="cfg-section">
      <header class="cfg-section__header">
        <h2 class="cfg-section__title">Numeração automática</h2>
        <p class="cfg-section__help">
          Cada linha monta uma parte do número: <strong>préfixo</strong> + <strong>parâmetro</strong> + <strong>sufixo</strong>.
          O resultado final é a junção das linhas na ordem.
        </p>
      </header>

      <div class="cfg-grid">
        <div class="cfg-field cfg-field--narrow">
          <label class="cfg-label" for="{{ form.numero_auto_iniciar.id_for_label }}">Número automático iniciar a partir de</label>
          <div class="cfg-control">
            {{ form.numero_auto_iniciar }}
          </div>
          <div class="cfg-errors">{{ form.numero_auto_iniciar.errors }}</div>
          <p class="cfg-hint text-muted">Ex.: 1000. Esse é o valor base do contador automático.</p>
        </div>

        <div class="cfg-field cfg-field--full">
          <div class="na-col">
            <div class="na-montagem-header">
              <div>
                <h3 class="na-title">Montagem do código</h3>
                <p class="na-help text-muted">
                  Exemplo: linha 1 → "PRO_" + Mês (MM) + Ano (AAAA); linha 2 → "" + Número automático + "".
                </p>
              </div>
              <button type="button" id="na-add-linha" class="btn btn-small">
                + Adicionar linha
              </button>
            </div>

            <table class="na-table">
              <thead>
                <tr>
                  <th style="width: 30%;">Préfixo</th>
                  <th style="width: 30%;">Parâmetro</th>
                  <th style="width: 30%;">Sufixo</th>
                  <th style="width: 10%;"></th>
                </tr>
              </thead>
              <tbody id="na-tbody">
                {# linhas via JS #}
              </tbody>
            </table>
          </div>

          <div class="na-preview">
            <div class="na-preview-header">
              <span>Pré-visualização do código</span>
              <button type="button" id="na-btn-preview" class="btn btn-small btn-outline">
                Atualizar exemplo
              </button>
            </div>
            <div class="na-preview-body">
              <div class="na-preview-label text-muted">
                Exemplo usando o próximo número (simulado) e a data de hoje:
              </div>
              <div class="na-preview-code" id="na-preview-codigo">
                — ainda sem configuração —
              </div>
            </div>
          </div>

          {{ form.numero_config_json }}
        </div>
      </div>
    </section>

    <div class="cfg-actions">
      <button type="submit" class="btn btn-primary">
        Salvar definições
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const tbody = document.getElementById("na-tbody");
  const btnAddLinha = document.getElementById("na-add-linha");
  const hiddenConfig = document.getElementById("id_numero_config_json");
  const previewCodigo = document.getElementById("na-preview-codigo");
  const btnPreview = document.getElementById("na-btn-preview");

  function criarLinha(prefixo = "", param = "", sufixo = "") {
    const tr = document.createElement("tr");
    tr.classList.add("na-row");

    const tdPrefixo = document.createElement("td");
    const inputPrefixo = document.createElement("input");
    inputPrefixo.type = "text";
    inputPrefixo.className = "na-input";
    inputPrefixo.value = prefixo;
    tdPrefixo.appendChild(inputPrefixo);

    const tdParam = document.createElement("td");
    const selectParam = document.createElement("select");
    selectParam.className = "na-select";
    const optVazio = document.createElement("option");
    optVazio.value = "";
    optVazio.textContent = "— selecione —";
    selectParam.appendChild(optVazio);

    const params = [
      { valor: "dia", label: "Dia (DD)" },
      { valor: "mes", label: "Mês (MM)" },
      { valor: "ano", label: "Ano (AAAA)" },
      { valor: "horario", label: "Horário (HHMM)" },
      { valor: "numero", label: "Número automático" },
    ];
    params.forEach(function (p) {
      const opt = document.createElement("option");
      opt.value = p.valor;
      opt.textContent = p.label;
      if (p.valor === param) opt.selected = true;
      selectParam.appendChild(opt);
    });
    tdParam.appendChild(selectParam);

    const tdSufixo = document.createElement("td");
    const inputSufixo = document.createElement("input");
    inputSufixo.type = "text";
    inputSufixo.className = "na-input";
    inputSufixo.value = sufixo;
    tdSufixo.appendChild(inputSufixo);

    const tdAcoes = document.createElement("td");
    tdAcoes.className = "na-actions-cell";
    tdAcoes.innerHTML = `
      <button type="button" class="na-row-up" title="Mover para cima">&#8593;</button>
      <button type="button" class="na-row-down" title="Mover para baixo">&#8595;</button>
      <button type="button" class="na-row-del" title="Remover">&#10005;</button>
    `;

    tr.appendChild(tdPrefixo);
    tr.appendChild(tdParam);
    tr.appendChild(tdSufixo);
    tr.appendChild(tdAcoes);

    tbody.appendChild(tr);
  }

  btnAddLinha.addEventListener("click", function () {
    criarLinha("", "", "");
    atualizarPreview();
  });

  tbody.addEventListener("click", function (e) {
    const tr = e.target.closest("tr");
    if (!tr) return;

    if (e.target.classList.contains("na-row-up")) {
      const prev = tr.previousElementSibling;
      if (prev) tbody.insertBefore(tr, prev);
      atualizarPreview();
    } else if (e.target.classList.contains("na-row-down")) {
      const next = tr.nextElementSibling;
      if (next) tbody.insertBefore(next, tr);
      atualizarPreview();
    } else if (e.target.classList.contains("na-row-del")) {
      tr.remove();
      atualizarPreview();
    }
  });

  function lerConfiguracao() {
    const linhas = [];
    tbody.querySelectorAll("tr").forEach(function (tr) {
      const inputs = tr.querySelectorAll("input.na-input");
      const select = tr.querySelector("select.na-select");
      const prefixo = inputs[0] ? inputs[0].value : "";
      const sufixo = inputs[1] ? inputs[1].value : "";
      const param = select ? select.value : "";
      if (!prefixo && !param && !sufixo) return;
      linhas.push({ prefixo: prefixo || "", param: param || "", sufixo: sufixo || "" });
    });
    return linhas;
  }

  function atualizarPreview() {
    const cfg = lerConfiguracao();
    hiddenConfig.value = JSON.stringify(cfg);

    if (!cfg.length) {
      previewCodigo.textContent = "— ainda sem configuração —";
      return;
    }

    const agora = new Date();
    const contexto = {
      numero: "1100",
      dia: String(agora.getDate()).padStart(2, "0"),
      mes: String(agora.getMonth() + 1).padStart(2, "0"),
      ano: String(agora.getFullYear()),
      horario: String(agora.getHours()).padStart(2, "0") + String(agora.getMinutes()).padStart(2, "0"),
    };

    const partes = cfg.map(function (linha) {
      const valorParam = linha.param ? (contexto[linha.param] || "") : "";
      return (linha.prefixo || "") + valorParam + (linha.sufixo || "");
    });

    const codigo = partes.join("");
    previewCodigo.textContent = codigo || "— ainda sem configuração —";
  }

  tbody.addEventListener("input", atualizarPreview);
  tbody.addEventListener("change", atualizarPreview);
  if (btnPreview) btnPreview.addEventListener("click", atualizarPreview);

  try {
    const inicial = hiddenConfig.value;
    if (inicial) {
      const cfg = JSON.parse(inicial);
      (cfg || []).forEach(function (linha) {
        criarLinha(linha.prefixo || "", linha.param || "", linha.sufixo || "");
      });
    }
  } catch (e) {
    console.warn("Não foi possível carregar configuração de numeração:", e);
  }

  if (!tbody.querySelector("tr")) {
    criarLinha("", "numero", "");
  }

  atualizarPreview();
});
</script>
{% endblock %}